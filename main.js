// main.js - Vee frontend + assistant UI (trimmed)
(function(){
  function getData(){ return JSON.parse(localStorage.getItem('vee_data')||'null'); }
  function setData(d){ localStorage.setItem('vee_data', JSON.stringify(d)); }
  function ensure(){ if(getData()) return; setData({ users:[{id:1,username:'Vee',password:'411',accountNumber:'ADMIN001A',isAdmin:true,points:300,purchases:[],reads:0,history:[]}], sections:[{id:'terminal',name:'ØªØ±Ù…ÙƒØ³',subsections:[{id:'basics',name:'Ø§Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„ØªØ±Ù…ÙƒØ³',paid:false,price:0,content:'ØªØ¹Ù„Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª...'}]},{id:'whatsapp',name:'ÙˆØ§ØªØ³Ø§Ø¨',subsections:[{id:'reverse',name:'Ù†Ø³Ø®Ø© Ø¹ÙƒØ³',paid:false,price:0,content:'Ù†Ø³Ø®Ø© Ø¹ÙƒØ³...'}]}], achievements:[{id:'a1',name:'Ù‚Ø§Ø±Ø¦ Ù…Ø¨ØªØ¯Ø¦',rule:{type:'reads',value:5}},{id:'a2',name:'Ù…Ø´ØªØ±ÙŠ 3',rule:{type:'purchases',value:3}}] }); }
  ensure();
  function toast(msg,t=2200){ const el=document.getElementById('toast'); if(!el) return; el.innerText=msg; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),t); }
  function genAcc(users){ const letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ'; let acc; do{ acc='12'+(100+Math.floor(Math.random()*900))+letters.charAt(Math.floor(Math.random()*letters.length)); }while(users.some(u=>u.accountNumber===acc)); return acc; }

  const lf=document.getElementById('loginForm');
  if(lf){ document.getElementById('openRegister').addEventListener('click', ()=> document.getElementById('registerModal').classList.remove('hidden')); document.getElementById('closeRegister').addEventListener('click', ()=> document.getElementById('registerModal').classList.add('hidden')); document.getElementById('registerForm').addEventListener('submit', function(e){ e.preventDefault(); const name=document.getElementById('regName').value.trim(); const pass=document.getElementById('regPass').value; const data=getData(); if(data.users.some(u=>u.username.toLowerCase()===name.toLowerCase())){ alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯'); return; } const acc=genAcc(data.users); const nu={id:data.users.length+1,username:name,password:pass,accountNumber:acc,isAdmin:false,points:50,purchases:[],reads:0,history:[]}; data.users.push(nu); setData(data); localStorage.setItem('vee_session', JSON.stringify({id:nu.id})); toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); setTimeout(()=> location.href='dashboard.html',700); }); lf.addEventListener('submit', function(e){ e.preventDefault(); const name=document.getElementById('loginUsername').value.trim(); const pass=document.getElementById('loginPassword').value; const data=getData(); const u=data.users.find(x=>x.username===name && x.password===pass); if(!u){ alert('Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); return; } localStorage.setItem('vee_session', JSON.stringify({id:u.id})); toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); setTimeout(()=> location.href = u.isAdmin ? 'admin.html' : 'dashboard.html',700); }); }

  if(location.pathname.endsWith('dashboard.html')){
    const sess=JSON.parse(localStorage.getItem('vee_session')||'null'); if(!sess) location.href='login.html'; const data=getData(); const user=data.users.find(u=>u.id===sess.id); if(!user){ localStorage.removeItem('vee_session'); location.href='login.html'; }
    document.getElementById('pName').innerText = user.username; document.getElementById('pAccount').innerText = user.accountNumber; document.getElementById('pPoints').innerText = (user.points||0)+' Ù†Ù‚Ø·Ø©';
    const badges = document.getElementById('badges'); const history = document.getElementById('history');
    user.reads = user.reads || 0;
    const totalItems = data.sections.reduce((acc,s)=>acc+s.subsections.length,0);
    const completed = (user.purchases||[]).length + (user.reads||0);
    const pct = Math.min(100, Math.round((completed/totalItems)*100));
    document.getElementById('progressFill').style.width = pct+'%';
    badges.innerHTML=''; data.achievements.forEach(a=>{ let earned=false; if(a.rule.type==='reads' && user.reads>=a.rule.value) earned=true; if(a.rule.type==='purchases' && (user.purchases||[]).length>=a.rule.value) earned=true; const el=document.createElement('div'); el.className='badge'; el.innerText = (earned? 'ğŸ… ':'') + a.name; badges.appendChild(el); });
    history.innerHTML=''; (user.purchases||[]).concat(user.history||[]).forEach(h=>{ const r=document.createElement('div'); r.innerText = h; history.appendChild(r); });
    document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('vee_session'); toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); setTimeout(()=> location.href='index.html',700); });
    document.getElementById('chatSend').addEventListener('click', async ()=>{ const msg = document.getElementById('chatInput').value.trim(); if(!msg) return; addChat('user', msg); document.getElementById('chatInput').value=''; try{ const reply = await askAI(msg); addChat('bot', reply); }catch(err){ addChat('bot','Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯'); console.error(err); } });
  }

  if(location.pathname.endsWith('store.html')){ const data=getData(); const sess=JSON.parse(localStorage.getItem('vee_session')||'null'); const user = sess? data.users.find(u=>u.id===sess.id):null; const area=document.getElementById('storeArea'); area.innerHTML=''; data.sections.forEach(sec=> sec.subsections.filter(s=>s.paid).forEach(sub=>{ const c=document.createElement('div'); c.className='card'; c.innerHTML = '<h4>'+sub.name+'</h4><div>'+sec.name+'</div><div>'+sub.price+' Ù†Ù‚Ø·Ø©</div>'; const btn=document.createElement('button'); btn.className='btn primary'; btn.innerText = user ? 'Ø´Ø±Ø§Ø¡' : 'Ø³Ø¬Ù„ Ù„Ù„Ø¯ÙØ¹'; btn.addEventListener('click', ()=>{ if(!user){ alert('Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'); return; } if((user.points||0) < sub.price){ alert('Ù†Ù‚Ø§Ø· ØºÙŠØ± ÙƒØ§ÙÙŠØ©'); return; } if(confirm('Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŸ')){ user.points=(user.points||0)-sub.price; user.purchases=(user.purchases||[]).concat([sec.id+'-'+sub.id]); user.history = (user.history||[]).concat(['Ø§Ø´ØªØ±ÙŠØª '+sub.name]); setData(data); toast('ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡'); } }); c.appendChild(btn); area.appendChild(c); })); }

  if(location.pathname.endsWith('admin.html')){ const sess=JSON.parse(localStorage.getItem('vee_session')||'null'); if(!sess) location.href='login.html'; const data=getData(); const admin=data.users.find(u=>u.id===sess.id && u.isAdmin); if(!admin){ localStorage.removeItem('vee_session'); location.href='login.html'; } const content=document.getElementById('adminContent'); function render(panel){ if(panel==='dashboard'){ content.innerHTML = '<h3>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h3><div class=\"grid\"><div class=\"card\">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: '+data.users.length+'</div><div class=\"card\">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: '+data.sections.length+'</div></div>'; } if(panel==='sections'){ let html='<h3>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h3>'; data.sections.forEach((sec,si)=>{ html += '<div class=\"card\"><strong>'+sec.name+'</strong>'; sec.subsections.forEach((sub,subi)=> html += '<div>'+sub.name+' '+(sub.paid?('('+sub.price+' Ù†Ù‚Ø·Ø©)'):'')+' <button data-si=\"'+si+'\" data-sub=\"'+subi+'\" class=\"btn">ØªØ¹Ø¯ÙŠÙ„</button></div>'); html += '<div class=\"row\"><button data-add=\"'+si+'\" class=\"btn success\">Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ø§Ø©</button></div></div>'; }); content.innerHTML = html; content.querySelectorAll('button[data-add]').forEach(b=> b.addEventListener('click', e=> openTool({si:parseInt(e.target.getAttribute('data-add'))}))); content.querySelectorAll('button[data-si]').forEach(b=> b.addEventListener('click', e=> openTool({si:parseInt(e.target.getAttribute('data-si')), subIndex:parseInt(e.target.getAttribute('data-sub')), mode:'edit'}))); } if(panel==='users'){ let html='<h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</h3>'; data.users.forEach((u,ui)=> html += '<div class=\"card\">'+u.username+' '+(u.isAdmin?'<span>(Ø£Ø¯Ù…Ù†)</span>':'')+'<div>'+u.accountNumber+'</div><div>Ù†Ù‚Ø§Ø·: '+(u.points||0)+'</div></div>'); content.innerHTML = html; } } document.querySelectorAll('button[data-panel]').forEach(b=> b.addEventListener('click', ()=> render(b.getAttribute('data-panel')))); render('dashboard'); window.openTool = function(opts){ const si=opts.si; const title = prompt('Ø§Ø³Ù… Ø§Ù„Ø£Ø¯Ø§Ø©'); if(!title) return; const isPaid = confirm('Ù‡Ù„ Ø§Ù„Ø£Ø¯Ø§Ø© Ù…Ø¯ÙÙˆØ¹Ø©ØŸ OK = Ù†Ø¹Ù…'); const price = isPaid ? parseFloat(prompt('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø± (Ù†Ù‚Ø·Ø©)'))||0 : 0; const content = prompt('Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£Ø¯Ø§Ø©'); const img = null; data.sections[si].subsections.push({ id:'sub'+Date.now(), name:title, paid:isPaid, price:price, content:content, image:img }); setData(data); toast('ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©'); render('sections'); }; document.getElementById('adminLogout').addEventListener('click', ()=>{ localStorage.removeItem('vee_session'); toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬'); setTimeout(()=> location.href='login.html',700); }); }

  if(location.pathname.endsWith('code_explain.html')){ function detectLang(code){ const first = code.trim().split('\n')[0]; if(/\bdef\b|:\s*$/.test(first)) return 'python'; if(/<\/?(html|div|script)/i.test(code)) return 'html'; if(/function\s+|=>|console\.log/.test(code)) return 'javascript'; if(/\{[^}]*\}/.test(code) && /:\s*[^;]+;/.test(code)) return 'css'; return 'text'; } document.getElementById('explainBtn').addEventListener('click', async ()=>{ const code = document.getElementById('codeInput').value || ''; let lang = document.getElementById('codeLang').value || detectLang(code); const out = document.getElementById('explainOutput'); if(!code.trim()){ alert('Ø£Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹'); return; } try{ const resp = await askAI('Ø§Ø´Ø±Ø­ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯:\\n'+code); out.innerText = resp; }catch(err){ const lines = code.split('\n'); const explanations = lines.map((ln,i)=> (i+1)+'. '+ln.trim()); out.innerText = 'Ø´Ø±Ø­ Ø¨Ø¯Ø§Ø¦ÙŠ (Ù…Ø­Ù„ÙŠ):\\n'+explanations.join('\\n'); } }); document.getElementById('voiceExplain').addEventListener('click', ()=>{ document.getElementById('explainBtn').click(); const text = document.getElementById('explainOutput').innerText || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±Ø­'; if('speechSynthesis' in window){ const ut = new SpeechSynthesisUtterance(text); ut.lang='ar-SA'; speechSynthesis.speak(ut); } else alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù†Ø·Ù‚'); }); }

  // assistant UI
  const assistantBtn = document.getElementById('assistantBtn');
  if(assistantBtn){
    const panel = document.createElement('div'); panel.className='assistant-panel hidden'; panel.id='assistantPanel';
    panel.innerHTML = '<div class="assistant-header"><strong>Vee Assistant</strong><button id="assistantClose" class="btn">X</button></div><div class="assistant-messages" id="assistantMessages"></div><div class="assistant-input"><input id="assistantInput" placeholder="Ø§Ø³Ø£Ù„ Vee..." /><button id="assistantSend" class="btn primary">Ø¥Ø±Ø³Ø§Ù„</button></div>';
    document.body.appendChild(panel);
    document.getElementById('assistantClose').addEventListener('click', ()=> panel.classList.add('hidden'));
    assistantBtn.addEventListener('click', ()=> panel.classList.toggle('hidden'));
    const messages = document.getElementById('assistantMessages');
    function addMsg(text, who){ const d=document.createElement('div'); d.className='msg '+(who==='user'?'user':'bot'); d.innerText=text; messages.appendChild(d); messages.scrollTop=messages.scrollHeight; }
    document.getElementById('assistantSend').addEventListener('click', async ()=>{ const input=document.getElementById('assistantInput'); const text=input.value.trim(); if(!text) return; addMsg(text,'user'); input.value=''; try{ const reply = await askAI(text); addMsg(reply,'bot'); if('speechSynthesis' in window){ const ut=new SpeechSynthesisUtterance(reply); ut.lang='ar-SA'; speechSynthesis.speak(ut); } }catch(err){ addMsg('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯.','bot'); } });
  }

  function addChat(who, text){ const area=document.getElementById('chatArea'); if(!area) return; const el=document.createElement('div'); el.className='msg '+(who==='user'?'user':'bot'); el.innerText=text; area.appendChild(el); area.scrollTop=area.scrollHeight; }

  async function askAI(message){
    if(window.callAIBridge){
      try{
        const res = await window.callAIBridge(message);
        if(res && res.reply) return res.reply;
        if(res && typeof res === 'string') return res;
        return JSON.stringify(res);
      }catch(err){ console.error('bridge error',err); }
    }
    if(message.toLowerCase().includes('ØªØ±Ù…ÙƒØ³')) return 'Ù„ØªØ¹Ù„Ù… ØªØ±Ù…ÙƒØ³: Ø§ÙØªØ­ Ø§Ù„Ù‚Ø³Ù… Ø«Ù… Ø§Ù‚Ø±Ø£ Ø§Ù„Ø£Ø¯ÙˆØ§Øª.';
    if(message.toLowerCase().includes('Ø´Ø±Ø­')) return 'ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ ØµÙØ­Ø© Ø´Ø±Ø­ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙˆØ³Ø£Ø­Ø§ÙˆÙ„ Ø´Ø±Ø­Ù‡.';
    return 'Ø¢Ø³ÙØŒ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ØºÙŠØ± Ù…ÙƒÙˆÙ‘Ù† Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ø³ØªØ®Ø¯Ù… Bridge Ù„Ø±Ø¨Ø·Ù‡ Ø¨Ù€ OpenAI.';
  }
})();